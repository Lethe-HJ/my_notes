# 准备工作

### 配置源

```
# CentOS-Base.repo
#
# The mirror system uses the connecting IP address of the client and the
# update status of each mirror to pick mirrors that are updated to and
# geographically close to the client.  You should use this for CentOS updates
# unless you are manually picking other mirrors.
#
# If the mirrorlist= does not work for you, as a fall back you can try the
# remarked out baseurl= line instead.
#
#


[base]
name=CentOS-$releasever - Base
baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos-altarch/$releasever/os/$basearch/
#mirrorlist=http://mirrorlist.centos-altarch.org/?release=$releasever&arch=$basearch&repo=os
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-7

#released updates
[updates]
name=centos-altarch-$releasever - Updates
baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos-altarch/$releasever/updates/$basearch/
#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=updates
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-7



#additional packages that may be useful
[extras]
name=CentOS-$releasever - Extras
baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos-altarch/$releasever/extras/$basearch/
#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=extras
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-7



#additional packages that extend functionality of existing packages
[centosplus]
name=CentOS-$releasever - Plus
baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos-altarch/$releasever/centosplus/$basearch/
#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=centosplus
gpgcheck=1
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-7
```

```
# epel.repo
[epel]
name=Extra Packages for Enterprise Linux 7 - $basearch
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/$basearch
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7

[epel-debuginfo]
name=Extra Packages for Enterprise Linux 7 - $basearch - Debug
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/$basearch/debug
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&arch=$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1

[epel-source]
name=Extra Packages for Enterprise Linux 7 - $basearch - Source
baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/SRPMS
#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&arch=$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1
```

分发到所有节点
scp /etc/yum.repos.d/CentOS-Base.repo root@compute2:/etc/yum.repos.d/CentOS-Base.repo
scp /etc/yum.repos.d/epel.repo root@compute2:/etc/yum.repos.d/epel.repo

然后每个节点执行
`yum clean all`
`yum makecache`

## 安装基础包
yum install net-tools -y
yum install vim -y

第一张网卡作为管理网 （management）

第二章网卡作为外部网络 （provider）
修改下列key值

```
DEVICE=INTERFACE_NAME
TYPE=Ethernet
ONBOOT="yes"
BOOTPROTO="none"
```

## 配置无密码登录

## hosts

## hostsname

## 关闭防火墙和selinux

`sudo systemctl stop firewalld` 临时关闭
`sudo systemctl disable firewalld` 然后reboot 永久关闭
`sudo systemctl status  firewalld` 查看防火墙状态。

`sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config`
`setenforce 0`

## 时间同步（chronyd）

在所有节点中安装chrony
yum install chrony -y

controller1中
vim /etc/chrony.conf
注释掉所有类似下面这行的所有行

server 0.centos.pool.ntp.org iburst 

添加这一行
server ntp1.aliyun.com iburst

allow 10.10.16.55/24
allow 10.10.16.56/24
allow 10.10.16.58/24
allow 10.10.16.59/24
allow 10.10.16.94/24


在controller2
vim /etc/chrony.conf
修改下面这一行
server controller1 iburst

拷贝到其他节点
scp /etc/chrony.conf root@controller2:/etc/chrony.conf
scp /etc/chrony.conf root@compute1:/etc/chrony.conf
scp /etc/chrony.conf root@compute2:/etc/chrony.conf

最后所有节点（要先在controller1上执行）
`systemctl enable chronyd.service`
`systemctl restart chronyd.service`
`chronyc sources` 同步时间


## 设置openstack packages

安装queen版yum源
yum install centos-release-openstack-queens -y
vim /etc/yum.repos.d/CentOS-OpenStack-queens.repo
```
[centos-openstack-queens]
name=CentOS-7 - OpenStack queens
#baseurl=http://mirror.centos.org/$contentdir/$releasever/cloud/$basearch/openstack-queens/
baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos-altarch/7/cloud/aarch64/openstack-queens/
```
yum upgrade -y

安装openstackclient
yum install python-openstackclient -y

selinux开启时需要安装openstack-selinux，这里已将seliux设置为默认关闭
yum install openstack-selinux -y

## 设置iptables

注意:如果你选择关闭防火墙 那么以下设置iptables的操作不需要

全部节点提前统一设置完成iptables，以controller01节点为例；
初始环境已使用iptables替代centos7.x自带的firewalld，同时关闭selinux；
[root@controller01 ~]# vim /etc/sysconfig/iptables
mariadb
tcp3306：服务监听端口；
tcp&udp4567：tcp做数据同步复制，多播复制同时采用tcp与udp；
tcp4568：增量状态传输；
tcp4444：其他状态快照传输；
tcp9200：心跳检测
-A INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 4444 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 4567:4568 -j ACCEPT
-A INPUT -p udp -m state --state NEW -m udp --dport 4567 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 9200 -j ACCEPT

rabbitmq
tcp4369：集群邻居发现；
tcp5671，5672：用于AMQP 0.9.1 and 1.0 clients使用；
tcp5673：非rabbitmq默认使用端口，这里用作hapoxy前端监听端口，避免后端服务与haproxy在1个节点时无法启动的问题；如果使用rabbitmq本身的集群机制，则可不设置此端口；
tcp15672：用于http api与rabbitadmin访问，后者仅限在management plugin开启时；
tcp25672：用于erlang分布式节点/工具通信
-A INPUT -p tcp -m state --state NEW -m tcp --dport 4369 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 5671:5673 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 15672:15673 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 25672 -j ACCEPT

memcached
tcp11211：服务监听端口；
-A INPUT -p tcp -m state --state NEW -m tcp --dport 11211 -j ACCEPT

pcs
tcp2224：pcs web管理服务监听端口，可通过web新建，查看，删除资源等，端口值在/usr/lib/pcsd/ssl.rb文件中设置；
udp5405：中间件corosync服务集群多播通信端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 2224 -j ACCEPT
-A INPUT -p udp -m state --state NEW -m udp --dport 5404:5405 -j ACCEPT

haproxy
tcp1080：haproxy监听端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 1080 -j ACCEPT

dashboard
tcp80：dashboard监听端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT

keystone
tcp35357：admin-api端口；
tcp5000：public/internal-api端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 35357 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 5000 -j ACCEPT

glance
tcp9191：glance-registry端口；
tcp9292：glance-api端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 9191 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 9292 -j ACCEPT

nova
tcp8773：nova-ec2-api端口；
tcp8774：nova-compute-api端口；
tcp8775：nova-metadata-api端口；
tcp8778：placement-api端口；
tcp6080：vncproxy端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 8773:8775 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 8778 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 6080 -j ACCEPT

cinder
tcp8776：cinder-api端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 8776 -j ACCEPT

neutron
tcp9696：neutron-api端口；
udp4789：vxlan目的端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 9696 -j ACCEPT
-A INPUT -p udp -m state --state NEW -m udp --dport 4789 -j ACCEPT

ceph
tcp6789：ceph-mon端口；
tcp6800~7300：ceph-osd端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 6789 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 6800:7300 -j ACCEPT

[root@controller01 ~]# service iptables restart