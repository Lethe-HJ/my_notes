# 快速开始

本指南提供了使用Kolla在裸机服务器或虚拟机上部署OpenStack的步骤说明。

## 推荐阅读

在运行Kolla-Ansible之前，学习Ansible和Docker的基础知识是有益的。

## 主机需求


+ 2张网卡
+ 8GB的主存
+ 40GB磁盘空间  

> 需要对部署主机进行根访问

## 安装依赖关系

在继续之前，请确保安装了pip包管理器并将其升级到最新版本。

对于centos,执行

    yum install epel-release
    yum install python-pip
    pip install -U pip

对于ubuntu,执行

    apt-get update
    apt-get install python-pip
    pip install -U pip

要使用pip包管理器构建代码，请安装以下依赖项:

对于centos,执行

    yum install python-devel libffi-devel gcc openssl-devel libselinux-python

对于ubuntu,执行

    apt-get install python-dev libffi-dev gcc libssl-dev python-selinux

Kolla使用Ansible部署OpenStack。安装Ansible从分布包装如果发行版包装已建议的版本可用。

## 准备初始配置

如果基于DEB的系统包含一个版本的Ansible，满足Kolla的版本要求，它可以安装:

    apt-get install ansible

将以下选项添加到ansible configuration file /etc/ansible/ansible.cfg是有益的:

    [defaults]
    host_key_checking=False
    pipelining=True
    forks=100

## 安装kolla-ansible

###　为部署和测试安装kolla-ansible

使用pip安装kolla-ansible及其依赖项。

    pip install kolla-ansible

复制lobals.yml和passwords.yml到/etc/kolla目录.

对于centos，执行

    cp -r /usr/share/kolla-ansible/etc_examples/kolla /etc/kolla/

对于ubuntu，执行

    cp -r /usr/local/share/kolla-ansible/etc_examples/kolla /etc/kolla/

将all-in-one和multinode inventory文件复制到当前目录。

对于centos，执行

    cp /usr/share/kolla-ansible/ansible/inventory/* .

对于ubuntu，执行

    cp /usr/local/share/kolla-ansible/ansible/inventory/* .

Kolla-ansible保存配置文件(globals.yml和password.yml) in etc/kolla

### 安装kolla用于开发

从git克隆Kolla和Kolla-ansible仓库

    git clone https://github.com/openstack/kolla
    git clone https://github.com/openstack/kolla-ansible

Kolla-ansible在etc/kolla目录下保存配置文件（globals.yml和passwords.yml），拷贝配置文件到etc/kolla目录下

    cp -r kolla-ansible/etc/kolla /etc/kolla/

Kolla-ansible在ansible/inventory中保存inventory文件(all-in-one和multinode)。将inventory中保存inventory文件文件复制到当前目录。

    cp kolla-ansible/ansible/inventory/* .

## 准备初始设置

### Inventory

下一步是准备我们的清单文件。Inventory是一个ansible文件，我们在其中指定节点角色和访问凭据。

Kolla-Ansiblea准备有all-in-one 和 multinode 的inventory示例文件。它们之间的区别是，前者可以在本地主机上部署单节点OpenStack。如果您需要使用单独的主机或一个以上的节点，编辑多节点库存:

编辑多节点的第一节与你的环境的连接细节，例如:

    [control]
    10.0.0.[10:12] ansible_user=ubuntu ansible_password=foobar ansible_become=true
    # Ansible supports syntax like [10:12] - that means 10, 11 and 12.
    # Become clausule means "use sudo".

    [network:children]
    control
    # when you specify group_name:children, it will use contents of group specified.

    [compute]
    10.0.0.[13:14] ansible_user=ubuntu ansible_password=foobar ansible_become=true

    [monitoring]
    10.0.0.10
    # This group is for monitoring node.
    # Fill it with one of the controllers' IP address or some others.

    [storage:children]
    compute

    [deployment]
    localhost       ansible_connection=local become=true
    # use localhost and sudo

要了解更多关于inventory文件，请查看Ansible文档。

为了确认我们的inventory是正确的，运行：

    ansible -m ping all

> Ubuntu可能没有预装python。这将导致ping模块中的错误。要快速安装python与ansible你可以运行` ansible -i multinode all -m raw -a "apt-get -y install python-dev"`

## Kolla passwords

部署中使用的密码存储在`/etc/kolla/passwords.yml`文件中。该文件中的所有密码都是空的，必须手动填写或运行随机密码生成器:

对于部署或评估，请运行:

    kolla-genpwd

对于开发，请运行

    cd kolla-ansible/tools
    ./generate_passwords.py

## Kolla globals.yml

globals.yml 是kolla-Ansible的主要配置文件。有几个选项需要用来部署Kolla-Ansible:

### Image options

用户必须指定将用于我们的部署的镜像。在本指南DockerHub提供的预构建镜像将被使用

有关构建机制的更多信息，请参阅映像构建文档。

Kolla在容器中提供了几种Linux发行版的选择:

+ Centos
+ Ubuntu
+ Oraclelinux
+ Debian
+ RHEL

对于新手，我们推荐使用CentOS 7或者Ubuntu 16.04。

接下来需要配置安装的“type”。选择有:

**binary**
    使用apt或yum之类的存储库

**source**
    使用原始源文件、git存储库或本地源目录

> 这只影响OpenStack服务。像Ceph这样的基础设施服务总是“二进制的”。

> 源代码构建被证明比二进制版本稍微可靠一些。

    kolla_install_type: "source"

要使用DockerHub镜像，必须覆盖默认的镜像 tag。image被标记为发布名称。例如使用稳定的 Pike 镜像集合

    openstack_release: "pike"

使用与kolla-ansible相同版本的镜像是很重要的。这意味着如果pip用于安装kolla-ansible，这意味着它是最新的稳定版本，所以openstack版本应该设置为pike。如果git与主分支一起使用，DockerHub还提供了daily主分支构建(被标记为主分支):

    openstack_release: "master"

### Networking

Kolla-Ansible需要设置一些网络选项。我们需要设置OpenStack使用的网络接口。

要设置的第一个接口是“网络接口”。这是多个管理类型网络的默认接口。

    network_interface: "eth0"

需要的第二个接口是用于Neutron外部(或公共)网络的，可以是vlan或flat，这取决于网络是如何创建的。这个接口应该是活动的，没有IP地址。否则，实例将无法访问外部网络。

    neutron_external_interface: "eth1"

有关网络配置的更多信息，请参阅网络概述。

接下来，我们需要为管理流量提供浮动IP。这个IP将由keepalived管理以提供高可用性，并且应该被设置为在连接到我们的网络接口的管理网络中没有被使用的地址。

    kolla_internal_vip_address: "10.1.0.250"

###　Enable additional services

默认情况下，Kolla-Ansible提供了一个简单的计算工具包，但是它确实提供了对大量附加服务的支持。要启用它们，将enable *设置为“yes”。例如，要启用块存储服务:

    enable_cinder: "yes"

Kolla现在支持许多OpenStack服务，这里有一个可使用的服务的清单。有关服务配置的更多信息，请参阅服务参考指南。

## 部署

设置好配置之后，我们就可以进入部署阶段了。首先，我们需要设置基本的主机级依赖项，比如docker。

Kolla-Ansible提供了一个脚本，将安装所有需要的服务在正确的版本。

对于部署和评估，运行：

1. 带有kolla部署依赖项的引导服务器:

    kolla-ansible -i ./multinode bootstrap-servers

2. 为主机做部署前检查:
   
    kolla-ansible -i ./multinode prechecks

3. 最后进行实际的OpenStack部署:
    
    kolla-ansible -i ./multinode deploy

对于开发，运行

1. 带有kolla部署依赖项的引导服务器:

    cd kolla-ansible/tools
    ./kolla-ansible -i ./multinode bootstrap-servers

2. 为主机做部署前检查:
   
    ./kolla-ansible -i ./multinode prechecks

3. 最后进行实际的OpenStack部署:
    
    ./kolla-ansible -i ./multinode deploy

当本playbook完成时，OpenStack应该已经启动并运行了!如果在执行过程中发生错误，请参阅故障排除指南。

##　使用openstack

OpenStack需要一个openrc文件，其中为管理用户等设置了凭证.要生成此文件，请运行

    kolla-ansible post-deploy
    . /etc/kolla/admin-openrc.sh

安装基本的OpenStack CLI客户端:

    pip install python-openstackclient python-glanceclient python-neutronclient

根据您安装Kolla-Ansible的方式，有一些脚本将创建示例网络、镜像等。

对于CentOS主机pip安装:

    . /usr/share/kolla-ansible/init-runonce

对于ubuntu主机pip安装:
    
    /usr/local/share/kolla-ansible/init-runonce

对于git拉取源码

    . kolla-ansible/tools/init-runonce