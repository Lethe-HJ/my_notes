## Mariadb集群

在全部controller节点安装mariadb
以下操作全部controller节点上都需要做

yum install mariadb mariadb-server python2-PyMySQL -y

安装galera相关插件，利用galera搭建集群
yum install mariadb-server-galera mariadb-galera-common xinetd rsync -y

社区版的galera不支持aarch64 会报错
GU_PAGE_SIZE(4096) does not maptch real system page size(65536)
解决方案:
wget http://192.168.80.251/centos-altarch/7/cloud/aarch64/openstack-queens/galera-25.3.23-5.el7.0.0.rdo0.aarch64.rpm
rpm -Uvh galera-25.3.23-5.el7.0.0.rdo0.aarch64.rpm

初始化mariadb
systemctl restart mariadb.service
mysql_secure_installation

修改mariadb配置文件
vim /etc/my.cnf.d/openstack.cnf

```
[mysqld]
binlog_format=ROW
bind-address = 10.10.16.55

default-storage-engine = innodb
innodb_file_per_table = on
max_connections = 4069
collation-server = utf8_general_ci
character-set-server = utf8

[galera]
bind-address = 10.10.16.55
wsrep_provider = /usr/lib64/galera/libgalera_smm.so
wsrep_cluster_address ="gcomm://controller1,controller2,controller3"
wsrep_cluster_name = openstack-cluster-01
wsrep_node_name = controller1
wsrep_node_address = 10.10.16.55
wsrep_on=ON
wsrep_slave_threads=4
wsrep_sst_method=rsync
default_storage_engine=InnoDB
[embedded]
[mariadb]
[mariadb-10.1] 

```

### 构建mariadb集群
停止全部控制节点的mariadb服务
systemctl stop mariadb.service

controller1节点以如下方式启动mariadb服务
/usr/libexec/mysqld --wsrep-new-cluster --user=root &

其他控制节点加入mariadb集群

systemctl start mariadb.service
systemctl status mariadb.service

重新启动controller1节点
启动前删除contrller1节点的数据
pkill -9 mysql
rm -rf /var/lib/mysql/*

chown mysql:mysql /var/run/mariadb/mariadb.pid
systemctl start mariadb.service
systemctl status mariadb.service

查看集群状态
mysql -uroot -pMYSQL_PASS

show status like "wsrep_cluster_size";
显示有3个

SHOW status LIKE 'wsrep_ready';
显示ON

### 设置心跳检测clustercheck

准备脚本
在controller1上
下载clustercheck脚本
wget https://raw.githubusercontent.com/olafz/percona-clustercheck/master/clustercheck

赋权
chmod +x clustercheck
cp ~/clustercheck /usr/bin/

### 创建心跳检测用户
mysql -uroot -pMYSQL_PASS
GRANT PROCESS ON *.* TO 'clustercheckuser'@'localhost' IDENTIFIED BY 'clustercheckpassword!';
FLUSH PRIVILEGES;

### 检测配置文件

在全部控制节点新增心跳检测服务配置文件/etc/xinetd.d/mysqlchk，以controller01节点为例

vim /etc/xinetd.d/mysqlchk
```
default: on
description: mysqlchk
service mysqlchk
{
   port = 9200
   disable = no
   socket_type = stream
   protocol = tcp
   wait = no
   user = root
   group = root
   groups = yes
   server = /usr/bin/clustercheck
   type = UNLISTED
   per_source = UNLIMITED
   log_on_success =
   log_on_failure = HOST
   flags = REUSE
} 
```

### 启动心跳检测服务

修改/etc/services，变更tcp9200端口用途，以controller01节点为例

vim /etc/services
#wap-wsp         9200/tcp                # WAP connectionless session service
mysqlchk        9200/tcp                # mysqlchk

启动xinetd服务，以controller01节点为例
systemctl daemon-reload
systemctl enable xinetd
systemctl start xinetd

### 测试心跳检测脚本

在全部控制节点验证，以controller01节点为例

/usr/bin/clustercheck


### 报错[ERROR] WSREP: failed to open gcomm backend connection: 110: failed to reach primary view: 110 (Connection timed out)
在三个controller节点上
systemctl stop mariadb.service
rm -rf /var/lib/mysql/galera.cache
rm -rf /var/lib/mysql/galera.dat
然后重新执行
构建mariadb集群这一步

### 报错 It may not be safe to bootstrap the cluster from this node. It was not the last one to leave the cluster and may not contain all the updates. To force cluster bootstrap with this node, edit the grastate.dat file manually and set safe_to_bootstrap to 1 .
按照报错提示做即可 
vim /var/lib/mysql/grastate.dat
```
safe_to_bootstrap: 1
```

## RabbitMQ集群

1. 安装rabbitmq

在全部控制节点，使用aliyun的epel镜像，以controller01节点为例
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
yum install erlang rabbitmq-server -y

设置开机启动
systemctl enable rabbitmq-server.service 

2. 构建rabbitmq集群

任选1个控制节点首先启动rabbitmq服务，这里选择controller1节点
systemctl start rabbitmq-server.service
rabbitmqctl cluster_status

分发.erlang.cookie
scp /var/lib/rabbitmq/.erlang.cookie root@controller1:/var/lib/rabbitmq/
scp /var/lib/rabbitmq/.erlang.cookie root@controller2:/var/lib/rabbitmq/

修改controller2/3节点.erlang.cookie文件的用户/组，以controller2节点为例
chown rabbitmq:rabbitmq /var/lib/rabbitmq/.erlang.cookie

注意修改全部控制节点.erlang.cookie文件的权限，默认即400权限，可不修改
ll /var/lib/rabbitmq/.erlang.cookie

启动controller2/3节点的rabbitmq服务 
systemctl start rabbitmq-server

构建集群，controller2/3节点以ram节点的形式加入集群
rabbitmqctl stop_app
rabbitmqctl join_cluster --ram rabbit@controller1
rabbitmqctl start_app


任意节点可验证集群状态
rabbitmqctl cluster_status

rabbitmq账号

在任意节点新建账号并设置密码，以controller01节点为例
rabbitmqctl add_user openstack rabbitmq_pass

设置新建账号的状态
rabbitmqctl set_user_tags openstack administrator

设置新建账号的权限
rabbitmqctl set_permissions -p "/" openstack ".*" ".*" ".*"

查看账号
rabbitmqctl list_users 

4. 镜像队列ha

设置镜像队列高可用
rabbitmqctl set_policy ha-all "^" '{"ha-mode":"all"}'

查看镜像队列策略
rabbitmqctl list_policies 

5. 安装web管理插件

在全部控制节点安装web管理插件，以controller01节点为例
rabbitmq-plugins enable rabbitmq_management

访问任意节点，如：http://172.30.200.31:15672

## Memcached集群

Memcached是无状态的，各控制节点独立部署，openstack各服务模块统一调用多个控制节点的memcached服务即可。

采用openstack官方的安装方法，如果需要部署最新版本memcached，可参考：http://www.cnblogs.com/netonline/p/7805900.html

以下配置以controller01节点为例。 
1. 安装memcached

在全部控制节点安装memcached
yum install memcached python-memcached -y

2. 设置memcached

在全部安装memcached服务的节点设置服务监听地址
sed -i 's|127.0.0.1,::1|0.0.0.0|g' /etc/sysconfig/memcached 

3. 开机启动

systemctl enable memcached.service
systemctl start memcached.service
systemctl status memcached.service


## mariadb too many connections

临时修改最大连接数

set GLOBAL max_connections=409600;
show variables like "%max_connections%";