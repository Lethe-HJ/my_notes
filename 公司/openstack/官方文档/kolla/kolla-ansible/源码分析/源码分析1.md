
## 介绍

kolla-ansible是从kolla项目中分离出来的一个可交付的项目。kolla-ansible负责部署容器化的openstack各个服务和基础设施组件；而kolla项目现在则单独负责镜像的构建，为kolla-ansible部署提供生产级别的openstack各服务镜像。

kolla-ansible利用ansible进行openstack服务的配置、编排openstack各个服务容器的部署。
利用容器的隔离性，达到openstack各服务容器的升级、回退，控制升级、回退的影响范围，降低openstack集群运维的复杂度。
## kolla-ansible目录结构

### 一级目录

.
├── ansible
├── bindep.txt
├── contrib
├── deploy-guide
├── doc
├── etc
├── kolla_ansible
├── LICENSE
├── README.rst
├── releasenotes
├── requirements.txt
├── setup.cfg
├── setup.py
├── specs
├── test-requirements.txt
├── tests
├── tools
└── tox.ini


+ Ansible: ansible的整个playbook代码,包括部署docker容器和openstack组件。源码主要集中在这个目录下。
+ Contrib:包括用heat和magnum的部署环境和vagrant的部署环境。
+ Deploy-guide: 部署指南，主要包括all-in-one和mulihosts两种部署方式的指南。
+ Doc:文档。
+ Etc: 一些配置文件，安装完了引用到了/etc目录下，all-in-one只要修改很少量的配置。
+ Kolla-ansible: 记录版本信息，cmd子目录下有生成密码和合并密码的两个脚本。pbr打包的时候被封装成为可执行命令。
+ Releasenodes: 发布特性说明。
+ Specs: 包含有Kolla社区关键参数代码库的变化。
+ Tests: 包括一些功能测试工具，这里还包括两个自定义的ansible plugin（merge_config）和module（kolla_docker）的测试。
+ Tools: 一些和kolla交换的脚本工具，大部分是可手动调用，主要完成一些安装前后的一些操作。有些会被ansible目录下的task调用到。


### 二级目录

Ansible/action_plugins: 自定义ansible插件，两个脚本，用于合并yml和conifg的配置文件。
Ansible/group_vars: ansible脚本的全局变量定义。
Ansible/inventory: 包含all-in-one和mulitnode的样板hosts清单。
Ansible/library: 包括一些自定义的ansible模块，bslurp.py和kolla_docker.py用到比较多。
Ansible/role: 所有的openstack的组件，几乎包含了说有开源项目，当前版本有60个组件。
Ansible:除了文件夹之外的ansible脚本，主要用户安装前后的环境准备和清理，数据库恢复等特殊系统级的操作。

Setup.cfg安装配置入口文件

    [metadata]
    name = kolla-ansible  // 项目名称
    summary = Ansible Deployment of Kolla containers
    description-file = README.rst
    author = OpenStack
    author-email = openstack-dev@lists.openstack.org
    home-page = http://docs.openstack.org/developer/kolla-ansible/
    license = Apache License, Version 2.0
    classifier =
        Environment :: OpenStack
        Intended Audience :: Information Technology
        Intended Audience :: System Administrators
        License :: OSI Approved :: Apache Software License
        Operating System :: POSIX :: Linux
        Programming Language :: Python
        Programming Language :: Python :: 2
        Programming Language :: Python :: 2.7
        Programming Language :: Python :: 3
        Programming Language :: Python :: 3.5

    [files]
    packages = kolla_ansible   //包名
    data_files =        //pbr方式打包对应的文件映射
        share/kolla-ansible/ansible = ansible/*
        share/kolla-ansible/tools = tools/validate-docker-execute.sh
        share/kolla-ansible/tools = tools/cleanup-containers
        share/kolla-ansible/tools = tools/cleanup-host
        share/kolla-ansible/tools = tools/cleanup-images
        share/kolla-ansible/tools = tools/stop-containers
    share/kolla-ansible/doc = doc/*
    share/kolla-ansible/etc_examples = etc/*
    share/kolla-ansible = tools/init-runonce
    share/kolla-ansible = tools/init-vpn
    share/kolla-ansible = tools/openrc-example
    share/kolla-ansible = setup.cfg

    scripts =        //可执行脚本
        tools/kolla-ansible

    [entry_points]
    console_scripts =   //控制台可执行脚本，执行两个Python文件的main函数
    kolla-genpwd = kolla_ansible.cmd.genpwd:main
    kolla-mergepwd = kolla_ansible.cmd.mergepwd:main

    [global]
    setup-hooks =
    pbr.hooks.setup_hook

    [pbr]  //打包方式

    [build_sphinx]
    all_files = 1
    build-dir = doc/build
    source-dir = doc

    [build_releasenotes]
    all_files = 1
    build-dir = releasenotes/build
    source-dir = releasenotes/source


Setup.py

安装执行脚本，通过pbr打包，执行过程会读取setup.cfg配置，还会安装同父目录下requirements.txt中的依赖

    import setuptools

    # In python < 2.7.4, a lazy loading of package `pbr` will break
    # setuptools if some other modules registered functions in `atexit`.
    # solution from: http://bugs.python.org/issue15881#msg170215
    try:
        import multiprocessing  # noqa
    except ImportError:
        pass

    setuptools.setup(
        setup_requires=['pbr>=2.0.0'],
        pbr=True)


tools\kolla-ansible

该脚本是封装了ansible-playbook，对kolla进行了ansible的定制。主要根据action的类型，传递不同的配置文件。
中间基础变量定义：

    find_base_dir
    INVENTORY="${BASEDIR}/ansible/inventory/all-in-one"
    PLAYBOOK="${BASEDIR}/ansible/site.yml"
    VERBOSITY=
    EXTRA_OPTS=${EXTRA_OPTS}
    CONFIG_DIR="/etc/kolla"
    PASSWORDS_FILE="${CONFIG_DIR}/passwords.yml"
    DANGER_CONFIRM=
    INCLUDE_IMAGES=



Ansible/role/neutron/task 检查场景

该场景的action是precheck。由tasks/main.yml引用precheck.yml。

    ---
    # kolla_container_facts是自定义的library，上文已经分析过代码，
    # 用于获取容器名为neutron_server的一些容器属性数据，注册到中间变量container_facts
    - name: Get container facts
    kolla_container_facts:
        name:
        - neutron_server
    register: container_facts

    # 中间变量container_facts没有找到neutron_server关键字且该主机在neutron-server主机组中，
    # 判断neutron_server_port 端口是否已经stopped
    - name: Checking free port for Neutron Server
    wait_for:
        host: "{{ hostvars[inventory_hostname]['ansible_' + api_interface]['ipv4']['address'] }}"
        port: "{{ neutron_server_port }}"
        connect_timeout: 1
        timeout: 1
        state: stopped
    when:
        - container_facts['neutron_server'] is not defined
        - inventory_hostname in groups['neutron-server']

    # enable_neutron_agent_ha是true,且只规划了多个一个dhcp和l3服务节点，给出fail提示
    - name: Checking number of network agents
    local_action: fail msg="Number of network agents are less than two when enabling agent ha"
    changed_when: false
    when:
        - enable_neutron_agent_ha | bool
        - groups['neutron-dhcp-agent'] | length < 2
        or groups['neutron-l3-agent'] | length < 2

    # When MountFlags is set to shared, a signal bit configured on 20th bit of a number
    # We need to check the 20th bit. 2^20 = 1048576. So we are validating against it.
    # 检查docker服务的MountFlags是否设置为了shared
    - name: Checking if 'MountFlags' for docker service is set to 'shared'
    command: systemctl show docker
    register: result
    changed_when: false
    failed_when: result.stdout.find('MountFlags=1048576') == -1
    when:
        - (inventory_hostname in groups['neutron-dhcp-agent']
        or inventory_hostname in groups['neutron-l3-agent']
        or inventory_hostname in groups['neutron-metadata-agent'])
        - ansible_os_family == 'RedHat' or ansible_distribution == 'Ubuntu'
