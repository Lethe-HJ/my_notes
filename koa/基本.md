## 简介

Koa 就是一种简单好用的 [Web 框架](https://www.lisa33xiaoq.net/?s=框架)。它的特点是优雅、简洁、表达力强、自由度高。本身代码只有 1000 多行，所有功能都通过插件实现，很符合 Unix 哲学。

安装koa

`yarn add koa`

## koa中间件

### 1、定义

使用`app.use()`注册的函数。每次客户端的请求，koa都会调用。

### 2、基本格式

```js
//ctx：上下文，核心对象
//next：将处理的控制权转交给下一个中间件
app.use(async (ctx, next)=>{
  //...
  await next()    //等待下个中间件运行结束，才运行当前中间件的后续代码
  //...
})
```

## get请求接收的实现

demo1.js

```js
const Koa = require('koa');
const app = new Koa();
app.use(async (ctx) => {
    let url = ctx.url;

    //从request中获取GET请求
    //query：返回的是格式化好的参数对象
    let req_query = ctx.request.query;
    //等效于ctx.query

    //querystring：返回的是请求字符串
    let req_querystring = ctx.request.querystring;
    //等效于ctx.querystring
    //ctx、ctx.request都具备相同的query、querystring

    ctx.body = {
        url,
        req_query,
        req_querystring,
    }
});

app.listen(3000, () => {
    console.log('[demo] server is starting at port 3000');
});


const Koa = require('koa');
const app = new Koa();
app.use(async (ctx) => {
    let url = ctx.url;

    let req_query = ctx.request.query;
    let req_querystring = ctx.request.querystring;
    ctx.body = {
        url,
        req_query,
        req_querystring,
    }
});

app.listen(3000, () => {
    console.log('[demo] server is starting at port 3000');
});
```

执行`node demo1.js`
然后访问`127.0.0.1:3000/hahaha?ad=1`即可得到响应

```json
{
    "url": "/hahaha?ad=1",
    "req_query": {
        "ad": "1"
    },
    "req_querystring": "ad=1"
}
```

### context对象

Koa 提供一个 Context 对象，表示一次对话的上下文（包括 HTTP 请求和 HTTP 回复）。通过加工这个对象，就可以控制返回给用户的内容。

`Context.response.body` 属性就是发送给用户的内容。


### HTTP Response 的类型

Koa 默认的返回类型是 text/plain，如果想返回其他类型的内容，可以先用 ctx.request.accepts 判断一下，客户端希望接受什么数据（根据 HTTP Request 的 Accept 字段），然后使用 ctx.response.type 指定返回类型。

```js
if (ctx.request.accepts('html')) {     
  ctx.response.type = 'html';     
  ctx.response.body = '<p>Hello World</p>';   
}
```

### 模版文件

```js
ctx.response.type = 'html';   
ctx.response.body = fs.createReadStream('./hellword.html');
```